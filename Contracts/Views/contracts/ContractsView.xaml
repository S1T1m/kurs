<UserControl x:Class="Contracts.Views.contracts.ContractsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="2*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="1.3*"/>
            <RowDefinition Height="1.3*"/>
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
            <Button Content="Обновить"
                    Margin="0,0,8,0"
                    Command="{Binding RefreshCmd}"/>
            <Button Content="Добавить договор"
                    Margin="0,0,8,0"
                    Command="{Binding AddContractCmd}"/>
            <Button Content="Удалить выбранный"
                    Margin="0,0,8,0"
                    Command="{Binding DeleteSelectedCmd}"/>
            <Button Content="Сохранить всё"
                    Command="{Binding SaveAllCmd}"/>
            <TextBox Width="250"
                     Margin="16,0,0,0"
                     Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                     ToolTip="Поиск по теме, примечанию, дате или ID" />
            
        </StackPanel>

        <DataGrid Grid.Row="1"
                  ItemsSource="{Binding ItemsView}"
                  SelectedItem="{Binding Selected, Mode=TwoWay}"
                  AutoGenerateColumns="False"
                  IsReadOnly="False"
                  Margin="0,0,0,8">
            <DataGrid.Columns>
                <DataGridTextColumn Header="ID"
                                    Binding="{Binding ContractId}"
                                    IsReadOnly="True"
                                    Width="60" />
                <DataGridTextColumn Header="Дата"
                                    Binding="{Binding DateSigned, StringFormat={}{0:dd.MM.yyyy}}"
                                    Width="110" />
                <DataGridTextColumn Header="Тема"
                                    Binding="{Binding Subject}"
                                    Width="2*" />
                <DataGridTextColumn Header="Примечание"
                                    Binding="{Binding Note}"
                                    Width="2*" />
            </DataGrid.Columns>
        </DataGrid>

        <GroupBox Grid.Row="2" Header="Детали договора" Margin="0,0,0,8">
            <Grid Margin="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,8,8">
                    <TextBlock Text="Дата заключения"/>
                    <DatePicker SelectedDate="{Binding Selected.DateSigned, Mode=TwoWay}"
                                SelectedDateFormat="Short"/>
                </StackPanel>

                <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,8,8">
                    <TextBlock Text="Дата исполнения"/>
                    <DatePicker SelectedDate="{Binding Selected.DueDate, Mode=TwoWay}"
                                SelectedDateFormat="Short"/>
                </StackPanel>

                <StackPanel Grid.Row="0" Grid.Column="2" Margin="0,0,0,8">
                    <TextBlock Text="Тип договора"/>
                    <ComboBox ItemsSource="{Binding Types}"
                              DisplayMemberPath="Name"
                              SelectedValuePath="TypeId"
                              SelectedValue="{Binding Selected.TypeId, Mode=TwoWay}"/>
                </StackPanel>

                <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,8,8">
                    <TextBlock Text="Заказчик"/>
                    <ComboBox ItemsSource="{Binding Orgs}"
                              DisplayMemberPath="Name"
                              SelectedValuePath="OrgId"
                              SelectedValue="{Binding Selected.CustomerId, Mode=TwoWay}"/>
                </StackPanel>

                <StackPanel Grid.Row="1" Grid.Column="1" Margin="0,0,8,8">
                    <TextBlock Text="Исполнитель"/>
                    <ComboBox ItemsSource="{Binding Orgs}"
                              DisplayMemberPath="Name"
                              SelectedValuePath="OrgId"
                              SelectedValue="{Binding Selected.ContractorId, Mode=TwoWay}"/>
                </StackPanel>

                <StackPanel Grid.Row="1" Grid.Column="2" Margin="0,0,0,8">
                    <TextBlock Text="Стадия договора"/>
                    <ComboBox ItemsSource="{Binding Stages}"
                              DisplayMemberPath="Name"
                              SelectedValuePath="StageId"
                              SelectedValue="{Binding Selected.StageId, Mode=TwoWay}"/>
                </StackPanel>

                <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,0,8,0">
                    <TextBlock Text="Ставка НДС, %"/>
                    <ComboBox ItemsSource="{Binding Vats}"
                              DisplayMemberPath="Rate"
                              SelectedValuePath="VatId"
                              SelectedValue="{Binding Selected.VatId, Mode=TwoWay}"/>
                </StackPanel>

                <StackPanel Grid.Row="2" Grid.Column="1" Margin="0,0,8,0">
                    <TextBlock Text="Тема"/>
                    <TextBox Text="{Binding Selected.Subject, Mode=TwoWay}"/>
                </StackPanel>

                <StackPanel Grid.Row="2" Grid.Column="2">
                    <TextBlock Text="Примечание"/>
                    <TextBox Text="{Binding Selected.Note, Mode=TwoWay}"/>
                </StackPanel>
            </Grid>
        </GroupBox>

        <GroupBox Grid.Row="3" Header="Этапы" Margin="0,0,0,8">
            <DockPanel>
                <StackPanel DockPanel.Dock="Top"
                            Orientation="Horizontal"
                            Margin="8,8,8,4">
                    <Button Content="Добавить этап"
                            Margin="0,0,8,0"
                            Command="{Binding AddPhaseCmd}"/>
                    <Button Content="Удалить этап"
                            Command="{Binding DeletePhaseCmd}"/>
                </StackPanel>

                <DataGrid ItemsSource="{Binding Selected.Phases}"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          Margin="8">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="№"
                                            Binding="{Binding PhaseNum}"
                                            IsReadOnly="True"
                                            Width="40"/>

                        <DataGridTemplateColumn Header="Дата">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding DueDate, StringFormat=dd.MM.yyyy}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>

                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <DatePicker SelectedDate="{Binding DueDate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                SelectedDateFormat="Short" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                        
                        <DataGridComboBoxColumn Header="Стадия"
                                                SelectedValueBinding="{Binding StageId, Mode=TwoWay}"
                                                SelectedValuePath="StageId"
                                                DisplayMemberPath="Name"
                                                Width="150">
                            <DataGridComboBoxColumn.ElementStyle>
                                <Style TargetType="ComboBox">
                                    <Setter Property="ItemsSource"
                                            Value="{Binding DataContext.Stages,
                                                    RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                </Style>
                            </DataGridComboBoxColumn.ElementStyle>
                            <DataGridComboBoxColumn.EditingElementStyle>
                                <Style TargetType="ComboBox">
                                    <Setter Property="ItemsSource"
                                            Value="{Binding DataContext.Stages,
                                                    RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                </Style>
                            </DataGridComboBoxColumn.EditingElementStyle>
                        </DataGridComboBoxColumn>

                        <DataGridTextColumn Header="Сумма"
                                            Binding="{Binding Amount}"
                                            Width="*"/>
                        <DataGridTextColumn Header="Аванс"
                                            Binding="{Binding Advance}"
                                            Width="*"/>
                        <DataGridTextColumn Header="Тема этапа"
                                            Binding="{Binding Subject}"
                                            Width="2*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </DockPanel>
        </GroupBox>

        <GroupBox Grid.Row="4" Header="Оплаты">
            <DockPanel>
                <StackPanel DockPanel.Dock="Top"
                            Orientation="Horizontal"
                            Margin="8,8,8,4">
                    <Button Content="Добавить оплату"
                            Margin="0,0,8,0"
                            Command="{Binding AddPaymentCmd}"/>
                    <Button Content="Удалить оплату"
                            Command="{Binding DeletePaymentCmd}"/>
                </StackPanel>

                <DataGrid ItemsSource="{Binding Selected.Payments}"
                          AutoGenerateColumns="False"
                          Margin="8"
                          CanUserAddRows="False"
                          >
                    <DataGrid.Columns>
                        <DataGridTemplateColumn Header="Дата">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding PaymentDate, StringFormat=dd.MM.yyyy}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>

                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <DatePicker SelectedDate="{Binding PaymentDate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                SelectedDateFormat="Short" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTextColumn Header="Сумма"
                                            Binding="{Binding Amount}"
                                            Width="*" 
                                            />

                        <DataGridComboBoxColumn Header="Вид оплаты"
                                                SelectedValueBinding="{Binding PaymentTypeId, Mode=TwoWay}"
                                                SelectedValuePath="PaymentTypeId"
                                                DisplayMemberPath="Name"
                                                Width="150">
                            <DataGridComboBoxColumn.ElementStyle>
                                <Style TargetType="ComboBox">
                                    <Setter Property="ItemsSource"
                                            Value="{Binding DataContext.PayTypes,
                                                    RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                </Style>
                            </DataGridComboBoxColumn.ElementStyle>
                            <DataGridComboBoxColumn.EditingElementStyle>
                                <Style TargetType="ComboBox">
                                    <Setter Property="ItemsSource"
                                            Value="{Binding DataContext.PayTypes,
                                                    RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                </Style>
                            </DataGridComboBoxColumn.EditingElementStyle>
                        </DataGridComboBoxColumn>

                        <DataGridTextColumn Header="№ документа"
                                            Binding="{Binding DocumentNumber}"
                                            Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </DockPanel>
        </GroupBox>
    </Grid>
</UserControl>
